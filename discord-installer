#!/bin/sh

# yeh, really...
# but if you are reading this then you are a degenerate too!

myname=${0##*/}

disable_notifs=""

install_dir=/tmp/discord-installer
_update () {
  mkdir -p "$install_dir"
  # wget -c -P "$install_dir"/ --content-disposition "https://discord.com/api/download?platform=linux&format=deb"
  wget -c -P "$install_dir"/ --content-disposition "https://discord.com/api/download/canary?platform=linux&format=deb"
}

_install () {
  has_tty=""
  if tty | grep -qF  -e "dev/pts"; then
    has_tty=1
  fi
  if [ -n "$has_tty" ]; then
    sudo apt install "$install_dir"/discord-*.*.deb -y
  else
    if [ -n "$SUDO_ASKPASS" ]; then
      sudo -A apt install "$install_dir"/discord-*.*.deb -y
    else
      pkexec apt install "$install_dir"/discord-*.*.deb -y
    fi
  fi
}

_clean () {
  rm "$install_dir"/discord-*.*.deb
}

_better () {
  type betterdiscordctl || betterdiscordinstaller
  betterdiscordctl -v reinstall
}

notif_me () {
  if [ -z "$disable_notifs" ]; then
    notify-send -i discord-canary "$1"
  else
    printf '[%s]: %s\n\n' "$myname" "$1"
  fi
}

_upgrade () {
  _clean
  notif_me "Downloading update"
  _update
  notif_me "Installing update"
  _install
  notif_me "Installed update"
  # _better
  _clean
}

if tty | grep -qF -e "dev/tty"; then
  disable_notifs=1
  notif_me "running inside a tty, maybe consider installing this stuff when you got a GUI"
fi
case "$1" in
  "update")  _update  ;;
  "upgrade") _upgrade ;;
  "install") _install ;;
  "clean")   _clean   ;;
  "better")  _better  ;;
esac
