#!/bin/sh

myname="${0##*/}"

# gallery-dl
prog_name="gallery-dl"

# program installed by apt
prog_sys="/usr/bin/$prog_name"

# program installed by pipx and exported to your local bin path
prog_loc="$HOME/.local/bin/$prog_name"

# program installed by pip in a venv
prog_vev="$VIRTUAL_ENV/bin/$prog_name"

# the program
prog=""

if [ -x "$prog_sys" ]; then
    prog="$prog_sys"
fi
if [ -x "$prog_loc" ] && [ "$0" != "$(readlink "$prog_loc")" ]; then
    prog="$prog_loc"
elif [ -x "$prog_vev" ]; then
    prog="$prog_vev"
fi
if [ -z "$prog" ]; then
    printf '%s\n' "${myname}: no executable found by wrapper!"
    exit 1
fi

browser=$(xdg-settings get default-web-browser \
    | sed 's/\.desktop//; s/-browser//')

keyring=$(pgrep -a "keyring|kwallet|kdewallet" | cut -d" " -f2)

case "$keyring" in
    *gnome*)
        keyring="gnomekeyring"
        ;;
    *wallet*)
        keyring="kwallet"
        ;;
esac

if [ "$#" -gt 0 ]; then
    case "$1" in
        -h|--help)
            printf '%s\n'   "${myname}: $prog_name wrapper"
            printf '  %s\n' "this wrapper sets some commong flags for gallery-dl:"
            printf '  %s\n' "  --sleep-request        15-45"
            printf '  %s\n' "  --sleep                 2-10"
            printf '  %s\n' "  --cookies-from-browser \${browser}+\${keyring}"
            printf '  %s\n' "    the web browser name is determined with:"
            printf '  %s\n' "      'xdg-settings get default-web-browser'"
            printf '  %s\n' "    the keyring name is searched with:"
            printf '  %s\n' "      pgrep -a 'keyring|kwallet|kdewallet'"
            printf '  %s\n' "currently it expands to:"
            printf '  %s\n' "  --cookies-from-browser ${browser}+${keyring}"
            printf '  %s\n' "using the binary from:"
            printf '  %s\n' "  $prog"
            printf '\n'
            ;;
    esac
else
    printf '%s\n' "${myname}: no arguments passed!"
    exit 1
fi

exec $prog \
    --sleep-request 15-45 \
    --sleep 2-10 \
    --cookies-from-browser "${browser}"+"${keyring}" \
    "$@"
